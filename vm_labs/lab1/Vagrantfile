# ==============================================================================
# Web Exploitation Lab - Vagrantfile
# ==============================================================================
#
# Original Prompt:
# "Create a similar Vagranfile to the previous one, but now with the following
# services: FTP, Web Server and use Apache 2.4.49. If you have any question
# ask me, Also, save this prompt as a comment in the Vagrantfile, along with
# creation date and time and my username."
#
# Created: 2025-12-30
# Author: mguirao
# ==============================================================================
# WARNING: This VM is intentionally insecure for educational purposes only!
# - Apache 2.4.49 is vulnerable to CVE-2021-41773 (Path Traversal)
# - Anonymous FTP access without authentication
# - Exposed on public/bridged network
# - Use only in isolated lab environments
# ==============================================================================

Vagrant.configure("2") do |config|
  # Use Alpine Linux base box
  config.vm.box = "generic/alpine318"

  # Lab VM hostname
  config.vm.hostname = "web-exploitation-lab"

  # Public network (bridged) - VM will get an IP on your physical network
  config.vm.network "public_network", bridge: "wlp4s0"

  # VirtualBox provider settings
  config.vm.provider "virtualbox" do |vb|
    vb.name = "WebExploitationLab"
    vb.memory = "1024"
    vb.cpus = 2
  end

  # Provisioning script to set up FTP and Apache 2.4.49
  config.vm.provision "shell", inline: <<-SHELL
    echo "================================================"
    echo "Setting up Web Exploitation Lab"
    echo "This may take 10-15 minutes due to compilation"
    echo "================================================"

    # Update package index
    apk update

    # Install build dependencies for Apache
    apk add --no-cache \\
      build-base \\
      pcre-dev \\
      apr-dev \\
      apr-util-dev \\
      expat-dev \\
      wget \\
      perl \\
      vsftpd

    # Create installation directory
    mkdir -p /usr/local/src
    cd /usr/local/src

    echo "Downloading Apache 2.4.49..."
    # Download Apache 2.4.49 source
    wget -q https://archive.apache.org/dist/httpd/httpd-2.4.49.tar.gz
    tar -xzf httpd-2.4.49.tar.gz
    cd httpd-2.4.49

    # Download APR and APR-util for bundled compilation
    echo "Downloading APR and APR-util..."
    cd srclib
    wget -q https://archive.apache.org/dist/apr/apr-1.7.0.tar.gz
    wget -q https://archive.apache.org/dist/apr/apr-util-1.6.1.tar.gz
    tar -xzf apr-1.7.0.tar.gz
    tar -xzf apr-util-1.6.1.tar.gz
    mv apr-1.7.0 apr
    mv apr-util-1.6.1 apr-util
    cd ..

    echo "Configuring Apache 2.4.49..."
    # Configure Apache with necessary modules
    ./configure \\
      --prefix=/usr/local/apache2 \\
      --enable-mods-shared=all \\
      --enable-cgi \\
      --enable-cgid \\
      --with-included-apr

    echo "Compiling Apache (this will take several minutes)..."
    make -j$(nproc)

    echo "Installing Apache..."
    make install

    # Configure Apache
    echo "Configuring Apache for CGI and vulnerability..."
    cat > /usr/local/apache2/conf/httpd.conf <<'EOF'
ServerRoot "/usr/local/apache2"
Listen 80

LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule cgi_module modules/mod_cgi.so
LoadModule alias_module modules/mod_alias.so

User daemon
Group daemon

ServerAdmin root@localhost
ServerName localhost

<Directory />
    AllowOverride none
    Require all denied
</Directory>

DocumentRoot "/usr/local/apache2/htdocs"
<Directory "/usr/local/apache2/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>

<IfModule dir_module>
    DirectoryIndex index.html
</IfModule>

<Files ".ht*">
    Require all denied
</Files>

ErrorLog "logs/error_log"
LogLevel warn

<IfModule log_config_module>
    LogFormat "%h %l %u %t \\"%r\\" %>s %b" common
    CustomLog "logs/access_log" common
</IfModule>

<IfModule mime_module>
    TypesConfig conf/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
</IfModule>

# CGI directory (vulnerable configuration for CVE-2021-41773)
ScriptAlias /cgi-bin/ "/usr/local/apache2/cgi-bin/"
<Directory "/usr/local/apache2/cgi-bin">
    AllowOverride None
    Options None
    Require all granted
</Directory>
EOF

    # Create Apache service script
    cat > /etc/init.d/apache2 <<'EOF'
#!/sbin/openrc-run

name="apache2"
description="Apache HTTP Server"

command="/usr/local/apache2/bin/httpd"
command_args="-k start -DFOREGROUND"
command_background="yes"
pidfile="/usr/local/apache2/logs/httpd.pid"

depend() {
    need net
    after firewall
}

start_pre() {
    /usr/local/apache2/bin/httpd -t
}

stop() {
    /usr/local/apache2/bin/httpd -k stop
}

restart() {
    /usr/local/apache2/bin/httpd -k restart
}
EOF

    chmod +x /etc/init.d/apache2

    # Create a simple index page
    cat > /usr/local/apache2/htdocs/index.html <<'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Web Exploitation Lab</title>
</head>
<body>
    <h1>Welcome to Web Exploitation Lab</h1>
    <p>This is an intentionally vulnerable web server for educational purposes.</p>
    <p>Apache version: 2.4.49</p>
</body>
</html>
EOF

    # Create flag file
    echo "5f4dcc3b5aa765d61d8327deb882cf99" > /usr/local/apache2/htdocs/flag.txt
    chmod 644 /usr/local/apache2/htdocs/flag.txt

    # Configure vsftpd for anonymous FTP
    cat > /etc/vsftpd/vsftpd.conf <<'EOF'
# Anonymous FTP configuration
anonymous_enable=YES
local_enable=NO
write_enable=NO
anon_upload_enable=NO
anon_mkdir_write_enable=NO
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=YES
pam_service_name=vsftpd
seccomp_sandbox=NO
anon_root=/usr/local/apache2/htdocs
EOF

    # Start services
    rc-update add apache2 default
    rc-service apache2 start

    rc-update add vsftpd default
    rc-service vsftpd start

    # Display VM information
    echo "================================================"
    echo "Web Exploitation Lab is ready!"
    echo "================================================"
    echo "VM IP address(es):"
    ip -4 addr show | grep inet | grep -v 127.0.0.1
    echo ""
    echo "Services running:"
    echo "  - Web Server: http://<IP_ADDRESS>"
    echo "  - FTP: ftp://<IP_ADDRESS> (anonymous login)"
    echo ""
    echo "Flag location: /usr/local/apache2/htdocs/flag.txt"
    echo "================================================"
  SHELL

  # Display connection info after VM is up
  config.vm.post_up_message = <<-MSG
    ============================================================
    Web Exploitation Lab is ready!
    ============================================================

    To find the VM's IP address, run:
      vagrant ssh -c "ip -4 addr show eth1 | grep inet"

    Services:
      - Web Server: http://<VM_IP_ADDRESS>
      - FTP: ftp://<VM_IP_ADDRESS> (use 'anonymous' as username)

    Apache Version: 2.4.49 (CVE-2021-41773)
    Flag: Access via web server at /flag.txt

    WARNING: This VM is intentionally vulnerable!
    Use only for educational purposes in isolated environments.
    ============================================================
  MSG
end
